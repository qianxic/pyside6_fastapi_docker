# 遥感影像变化检测系统部署说明文档

## 一、部署概述

### 1.1 系统架构
遥感影像变化检测系统采用前后端分离的容器化架构设计，包含以下组件：
- **前端应用**：基于PySide6的桌面应用程序
- **后端API服务**：基于FastAPI的RESTful API服务
- **深度学习模型**：基于PyTorch的X3D变化检测模型
- **容器化部署**：Docker + Docker Compose

### 1.2 部署方式
- **开发环境**：本地Python环境部署
- **测试环境**：Docker容器化部署
- **生产环境**：高可用集群部署

## 二、环境要求

### 2.1 硬件要求
| 组件 | 最低要求 | 推荐配置 |
|------|----------|----------|
| CPU | 4核心 | 8核心以上 |
| 内存 | 8GB | 16GB以上 |
| 存储 | 50GB | 100GB以上 |
| GPU | 可选 | NVIDIA RTX 3080+ |
| 网络 | 100Mbps | 1Gbps |

### 2.2 软件要求
| 软件 | 版本要求 | 说明 |
|------|----------|------|
| 操作系统 | Windows 10+/Ubuntu 20.04+/macOS 10.15+ | 支持主流操作系统 |
| Python | 3.10+ | 核心运行环境 |
| Docker | 20.10+ | 容器化部署 |
| Docker Compose | 2.0+ | 容器编排 |
| CUDA | 12.6+ | GPU加速（可选） |
| NVIDIA驱动 | 535.98+ | GPU驱动（可选） |

### 2.3 网络要求
- **端口开放**：8000（API服务）、22（SSH）
- **网络带宽**：支持大文件上传下载
- **防火墙配置**：允许容器间通信

## 三、开发环境部署

### 3.1 环境准备

#### 3.1.1 安装Python
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install python3.10 python3.10-venv python3-pip

# CentOS/RHEL
sudo yum install python3.10 python3.10-pip

# Windows
# 下载Python 3.10+安装包：https://www.python.org/downloads/
```

#### 3.1.2 创建虚拟环境
```bash
# 创建虚拟环境
python3.10 -m venv rsiis_env

# 激活虚拟环境
# Linux/macOS
source rsiis_env/bin/activate

# Windows
rsiis_env\Scripts\activate
```

#### 3.1.3 安装依赖
```bash
# 升级pip
pip install --upgrade pip

# 安装依赖包
pip install -r requirements.txt
```

### 3.2 后端服务部署

#### 3.2.1 启动API服务
```bash
# 进入后端目录
cd change3d_api_docker

# 启动API服务
python run_api.py
```

#### 3.2.2 验证服务
```bash
# 测试API服务
curl http://localhost:8000/health

# 预期响应
{
    "status": "healthy",
    "message": "API服务运行正常",
    "timestamp": "2025-08-31T10:00:00Z"
}
```

### 3.3 前端应用部署

#### 3.3.1 启动前端应用
```bash
# 返回项目根目录
cd ..

# 启动前端应用
python start_app.py
```

#### 3.3.2 验证应用
- 检查应用界面是否正常显示
- 验证四区域布局是否正确
- 测试文件导入功能

## 四、Docker容器化部署

### 4.1 环境准备

#### 4.1.1 安装Docker
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install docker.io docker-compose

# CentOS/RHEL
sudo yum install docker docker-compose

# 启动Docker服务
sudo systemctl start docker
sudo systemctl enable docker

# 添加用户到docker组
sudo usermod -aG docker $USER
```

#### 4.1.2 安装NVIDIA Docker（可选）
```bash
# 添加NVIDIA Docker仓库
distribution=$(. /etc/os-release;echo $ID$VERSION_ID)
curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -
curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list

# 安装NVIDIA Docker
sudo apt update
sudo apt install nvidia-docker2

# 重启Docker服务
sudo systemctl restart docker
```

### 4.2 构建镜像

#### 4.2.1 构建后端镜像
```bash
# 进入后端目录
cd change3d_api_docker

# 构建镜像
docker build -f Dockerfile.optimized -t rsiis-api:v1.0 .

# 查看镜像
docker images | grep rsiis-api
```

#### 4.2.2 构建前端镜像
```bash
# 返回项目根目录
cd ..

# 构建前端镜像
docker build -f Dockerfile.frontend -t rsiis-frontend:v1.0 .

# 查看镜像
docker images | grep rsiis-frontend
```

### 4.3 容器编排部署

#### 4.3.1 创建docker-compose.yml
```yaml
version: '3.8'

services:
  rsiis-api:
    image: rsiis-api:v1.0
    container_name: rsiis-api
    ports:
      - "8000:8000"
    volumes:
      - ./data:/app/data
      - ./models:/app/models
      - ./logs:/app/logs
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - PYTHONPATH=/app
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  rsiis-frontend:
    image: rsiis-frontend:v1.0
    container_name: rsiis-frontend
    ports:
      - "8080:8080"
    volumes:
      - ./data:/app/data
      - ./config:/app/config
    environment:
      - API_BASE_URL=http://rsiis-api:8000
    depends_on:
      - rsiis-api
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    container_name: rsiis-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - rsiis-api
      - rsiis-frontend
    restart: unless-stopped

volumes:
  data:
  models:
  logs:
```

#### 4.3.2 启动服务
```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看服务日志
docker-compose logs -f
```

#### 4.3.3 验证部署
```bash
# 测试API服务
curl http://localhost:8000/health

# 测试前端服务
curl http://localhost:8080

# 查看容器状态
docker-compose ps
```

## 五、生产环境部署

### 5.1 高可用部署

#### 5.1.1 负载均衡配置
```nginx
# nginx/nginx.conf
upstream api_backend {
    server rsiis-api-1:8000;
    server rsiis-api-2:8000;
    server rsiis-api-3:8000;
}

upstream frontend_backend {
    server rsiis-frontend-1:8080;
    server rsiis-frontend-2:8080;
}

server {
    listen 80;
    server_name rsiis.example.com;

    location /api/ {
        proxy_pass http://api_backend/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location / {
        proxy_pass http://frontend_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

#### 5.1.2 数据库配置
```yaml
# docker-compose.prod.yml
services:
  postgres:
    image: postgres:13
    container_name: rsiis-postgres
    environment:
      POSTGRES_DB: rsiis
      POSTGRES_USER: rsiis_user
      POSTGRES_PASSWORD: secure_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  redis:
    image: redis:6-alpine
    container_name: rsiis-redis
    volumes:
      - redis_data:/data
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
```

### 5.2 监控配置

#### 5.2.1 Prometheus监控
```yaml
# monitoring/prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'rsiis-api'
    static_configs:
      - targets: ['rsiis-api:8000']

  - job_name: 'rsiis-frontend'
    static_configs:
      - targets: ['rsiis-frontend:8080']
```

#### 5.2.2 Grafana仪表板
```json
{
  "dashboard": {
    "title": "RSIIS系统监控",
    "panels": [
      {
        "title": "API响应时间",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_request_duration_seconds_sum[5m])"
          }
        ]
      },
      {
        "title": "GPU使用率",
        "type": "graph",
        "targets": [
          {
            "expr": "nvidia_gpu_utilization"
          }
        ]
      }
    ]
  }
}
```

### 5.3 安全配置

#### 5.3.1 SSL证书配置
```bash
# 生成SSL证书
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout nginx/ssl/private.key \
  -out nginx/ssl/certificate.crt
```

#### 5.3.2 防火墙配置
```bash
# Ubuntu/Debian
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=22/tcp
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --reload
```

## 六、配置管理

### 6.1 环境变量配置

#### 6.1.1 开发环境配置
```bash
# .env.development
API_HOST=0.0.0.0
API_PORT=8000
DEBUG=true
LOG_LEVEL=DEBUG
MODEL_PATH=/app/models/x3d_model.pth
GPU_ENABLED=true
CUDA_VISIBLE_DEVICES=0
```

#### 6.1.2 生产环境配置
```bash
# .env.production
API_HOST=0.0.0.0
API_PORT=8000
DEBUG=false
LOG_LEVEL=INFO
MODEL_PATH=/app/models/x3d_model.pth
GPU_ENABLED=true
CUDA_VISIBLE_DEVICES=0,1
DATABASE_URL=postgresql://user:pass@host:port/db
REDIS_URL=redis://host:port
```

### 6.2 配置文件管理

#### 6.2.1 应用配置文件
```python
# config/settings.py
import os
from typing import Optional

class Settings:
    # API配置
    API_HOST: str = os.getenv("API_HOST", "0.0.0.0")
    API_PORT: int = int(os.getenv("API_PORT", "8000"))
    DEBUG: bool = os.getenv("DEBUG", "false").lower() == "true"
    
    # 模型配置
    MODEL_PATH: str = os.getenv("MODEL_PATH", "/app/models/x3d_model.pth")
    GPU_ENABLED: bool = os.getenv("GPU_ENABLED", "true").lower() == "true"
    CUDA_VISIBLE_DEVICES: str = os.getenv("CUDA_VISIBLE_DEVICES", "0")
    
    # 数据库配置
    DATABASE_URL: Optional[str] = os.getenv("DATABASE_URL")
    REDIS_URL: Optional[str] = os.getenv("REDIS_URL")
    
    # 存储配置
    UPLOAD_DIR: str = os.getenv("UPLOAD_DIR", "/app/uploads")
    RESULT_DIR: str = os.getenv("RESULT_DIR", "/app/results")
    LOG_DIR: str = os.getenv("LOG_DIR", "/app/logs")
    
    # 安全配置
    SECRET_KEY: str = os.getenv("SECRET_KEY", "your-secret-key")
    ALLOWED_HOSTS: list = os.getenv("ALLOWED_HOSTS", "*").split(",")

settings = Settings()
```

#### 6.2.2 日志配置
```python
# config/logging.py
import logging
import logging.handlers
import os
from pathlib import Path

def setup_logging(log_level: str = "INFO", log_dir: str = "/app/logs"):
    """设置日志配置"""
    
    # 创建日志目录
    Path(log_dir).mkdir(parents=True, exist_ok=True)
    
    # 配置日志格式
    log_format = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
    date_format = "%Y-%m-%d %H:%M:%S"
    
    # 配置根日志器
    logging.basicConfig(
        level=getattr(logging, log_level.upper()),
        format=log_format,
        datefmt=date_format,
        handlers=[
            logging.handlers.RotatingFileHandler(
                os.path.join(log_dir, "rsiis.log"),
                maxBytes=10*1024*1024,  # 10MB
                backupCount=5
            ),
            logging.StreamHandler()
        ]
    )
    
    # 配置特定模块日志器
    logging.getLogger("uvicorn").setLevel(logging.INFO)
    logging.getLogger("fastapi").setLevel(logging.INFO)
```

## 七、维护管理

### 7.1 服务管理

#### 7.1.1 服务启动
```bash
# 启动所有服务
docker-compose up -d

# 启动特定服务
docker-compose up -d rsiis-api

# 查看服务状态
docker-compose ps
```

#### 7.1.2 服务停止
```bash
# 停止所有服务
docker-compose down

# 停止特定服务
docker-compose stop rsiis-api

# 停止并删除数据卷
docker-compose down -v
```

#### 7.1.3 服务重启
```bash
# 重启所有服务
docker-compose restart

# 重启特定服务
docker-compose restart rsiis-api

# 重新构建并启动
docker-compose up -d --build
```

### 7.2 日志管理

#### 7.2.1 查看日志
```bash
# 查看所有服务日志
docker-compose logs

# 查看特定服务日志
docker-compose logs rsiis-api

# 实时查看日志
docker-compose logs -f rsiis-api

# 查看最近100行日志
docker-compose logs --tail=100 rsiis-api
```

#### 7.2.2 日志清理
```bash
# 清理容器日志
docker system prune -f

# 清理特定容器日志
docker logs --truncate=0 rsiis-api

# 设置日志轮转
# 在docker-compose.yml中配置日志驱动
logging:
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
```

### 7.3 备份恢复

#### 7.3.1 数据备份
```bash
# 备份数据卷
docker run --rm -v rsiis_data:/data -v $(pwd):/backup alpine tar czf /backup/rsiis_data_backup.tar.gz -C /data .

# 备份配置文件
tar czf config_backup.tar.gz config/

# 备份模型文件
tar czf models_backup.tar.gz models/
```

#### 7.3.2 数据恢复
```bash
# 恢复数据卷
docker run --rm -v rsiis_data:/data -v $(pwd):/backup alpine tar xzf /backup/rsiis_data_backup.tar.gz -C /data

# 恢复配置文件
tar xzf config_backup.tar.gz

# 恢复模型文件
tar xzf models_backup.tar.gz
```

## 八、故障排除

### 8.1 常见问题

#### 8.1.1 容器启动失败
**问题**：容器无法启动
**解决方案**：
1. 检查Docker服务状态：`sudo systemctl status docker`
2. 查看容器日志：`docker-compose logs`
3. 检查端口占用：`netstat -tulpn | grep 8000`
4. 检查磁盘空间：`df -h`

#### 8.1.2 GPU不可用
**问题**：GPU加速不可用
**解决方案**：
1. 检查NVIDIA驱动：`nvidia-smi`
2. 检查CUDA安装：`nvcc --version`
3. 检查NVIDIA Docker：`docker run --rm --gpus all nvidia/cuda:12.6-base-ubuntu20.04 nvidia-smi`
4. 检查容器GPU配置

#### 8.1.3 内存不足
**问题**：内存不足导致服务崩溃
**解决方案**：
1. 检查内存使用：`free -h`
2. 调整容器内存限制
3. 优化模型加载策略
4. 增加系统交换空间

### 8.2 性能优化

#### 8.2.1 容器优化
```yaml
# docker-compose.optimized.yml
services:
  rsiis-api:
    image: rsiis-api:v1.0
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '4.0'
        reservations:
          memory: 4G
          cpus: '2.0'
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
```

#### 8.2.2 系统优化
```bash
# 优化系统参数
echo 'vm.max_map_count=262144' | sudo tee -a /etc/sysctl.conf
echo 'fs.file-max=65536' | sudo tee -a /etc/sysctl.conf
sudo sysctl -p

# 优化Docker配置
sudo tee /etc/docker/daemon.json <<EOF
{
  "default-ulimits": {
    "nofile": {
      "Hard": 64000,
      "Name": "nofile",
      "Soft": 64000
    }
  }
}
EOF
sudo systemctl restart docker
```

---

**文档版本**：V1.0
**创建日期**：2025年8月31日
**更新日期**：2025年8月31日
**技术支持**：support@rsiis.com
